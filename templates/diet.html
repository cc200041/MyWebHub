{% extends "base.html" %}
{% block content %}
{% raw %}
<div id="app" v-cloak class="max-w-5xl mx-auto p-4 space-y-4">

  <!-- é¡¶éƒ¨ï¼šç”¨æˆ· + ä»Šæ—¥æ¦‚è§ˆ -->
  <div class="pixel-box p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-green-50">
    <div class="flex items-center gap-3 cursor-pointer" @click="openUserModal">
      <div class="w-12 h-12 bg-green-500 border-2 border-black flex items-center justify-center text-white text-xl font-bold shadow-[4px_4px_0_black]">
        {{ profile.name ? profile.name[0] : 'P' }}
      </div>
      <div>
        <div class="text-lg font-bold">{{ profile.name || 'é»˜è®¤ç”¨æˆ·' }}</div>
        <div class="text-xs text-gray-500">ç‚¹å‡»ç®¡ç†ç”¨æˆ·ä¸èº«ä½“å‚æ•°</div>
      </div>
    </div>
    <div class="flex-1 grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
      <div>
        <div class="text-xs text-gray-500">ä»Šæ—¥å·²æ‘„å…¥</div>
        <div class="text-2xl font-bold">{{ dashboard.food_today.toFixed(0) }} kcal</div>
      </div>
      <div>
        <div class="text-xs text-gray-500">å‰©ä½™å¯æ‘„å…¥</div>
        <div class="text-2xl font-bold text-green-700">{{ remainingCal }} kcal</div>
      </div>
      <div>
        <div class="text-xs text-gray-500">å½“å‰ä½“é‡</div>
        <div class="text-2xl font-bold">{{ (profile.current_weight || 0).toFixed(1) }} kg</div>
      </div>
    </div>
    <div class="flex flex-col items-end gap-1">
      <input type="date" v-model="currentDate" @change="onDateChange" class="pixel-btn bg-white text-sm px-2 py-1">
      <span class="mt-1 inline-block text-xs px-2 py-1 border-2 border-black bg-yellow-300 font-bold">
        {{ bmiStatus }}
      </span>
    </div>
  </div>

  <!-- ä¸»ä½“ï¼šä¸¤åˆ— -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- å·¦åˆ—ï¼šèƒ½é‡ + è®°å½•å…¥å£ -->
    <div class="space-y-4">

      <!-- èƒ½é‡æ¡ -->
      <div class="pixel-box p-4 bg-[#243447] text-white">
        <div class="flex items-end justify-between mb-4">
          <div>
            <div class="text-xs text-green-300 mb-1">ENERGY LEFT</div>
            <div class="text-4xl font-extrabold" style="text-shadow:4px 4px 0 #000">{{ remainingCal }}</div>
          </div>
          <div class="text-right text-xs text-gray-200">
            <div>BMR ä¼°ç®—: {{ bmr }} kcal</div>
            <div>ç›®æ ‡ä½“é‡: {{ profile.target_weight || '--' }} kg</div>
          </div>
        </div>
        <div class="w-full h-6 border-2 border-white bg-gray-700 relative overflow-hidden">
          <div class="h-full bg-green-500 transition-all duration-500" :style="{width: progressWidth + '%'}"></div>
          <div class="absolute inset-y-0 left-1/4 w-px bg-black/30"></div>
          <div class="absolute inset-y-0 left-2/4 w-px bg-black/30"></div>
          <div class="absolute inset-y-0 left-3/4 w-px bg-black/30"></div>
        </div>
        <div class="flex justify-between mt-1 text-[10px] text-gray-300 font-mono">
          <span>INTAKE: {{ dashboard.food_today.toFixed(0) }}</span>
          <span>MAX: {{ bmr }}</span>
        </div>

        <div class="grid grid-cols-3 gap-2 mt-4">
          <button class="pixel-btn blue py-2 text-xs" @click="activeTab='search'">ğŸ” æœé£Ÿç‰©</button>
          <button class="pixel-btn py-2 text-xs" @click="activeTab='token'">ğŸ” å£ä»¤å¯¼å…¥</button>
          <button class="pixel-btn green py-2 text-xs" @click="activeTab='photo'">ğŸ“· æ‹ç…§è®°å½•</button>
        </div>
      </div>

      <!-- è®°å½•è¾“å…¥ Tabs -->
      <div class="pixel-box p-4 space-y-3">

        <!-- æœé£Ÿç‰© -->
        <div v-if="activeTab==='search'" class="space-y-3">
          <div class="flex gap-2">
            <input v-model="foodQ" @keyup.enter="searchFood" placeholder="è¾“å…¥é£Ÿç‰©åç§°ï¼Œä¾‹å¦‚ ç±³é¥­ / é¸¡èƒ¸è‚‰" class="flex-1 p-2 text-sm border-2 border-black">
            <button class="pixel-btn px-3 text-xs" @click="searchFood">æœç´¢</button>
          </div>
          <div class="max-h-52 overflow-y-auto text-sm border-t border-dashed border-gray-200 pt-2">
            <p v-if="!foodList.length" class="text-xs text-gray-400">
              ä»ä½ æ•´ç†å¥½çš„é£Ÿç‰©åº“é‡Œæœç´¢ï¼Œç‚¹å‡»ä¸€é¡¹å³å¯æŒ‰ä»½é‡è®°è´¦ã€‚
            </p>
            <div v-for="f in foodList" :key="f.name"
                 class="flex items-center justify-between py-1 border-b border-dashed border-gray-100">
              <div>
                <span class="mr-1">{{ f.emoji || 'ğŸ½' }}</span>{{ f.name }}
                <span class="ml-2 text-xs text-gray-500">{{ f.cal }} kcal / 100g</span>
              </div>
              <button class="pixel-btn px-2 text-xs" @click="quickAddFood(f)">+ è®°å½•</button>
            </div>
          </div>
        </div>

        <!-- å£ä»¤å¯¼å…¥ -->
        <div v-else-if="activeTab==='token'" class="space-y-3">
          <textarea v-model="tokenInput" rows="3" placeholder="ç²˜è´´å°ka å¨æˆ¿ç”Ÿæˆçš„å£ä»¤ï¼Œä¾‹å¦‚ #HTC:çº¢çƒ§é¸¡è…¿:520#" class="w-full text-sm p-2 border-2 border-black"></textarea>
          <div class="flex justify-between items-center text-xs text-gray-500">
            <span>æ”¯æŒå¤šä¸ªå£ä»¤ï¼Œé€æ¡è§£æã€‚</span>
            <button class="pixel-btn px-3 text-xs" @click="parseToken">è§£æå¹¶è®°è´¦</button>
          </div>
        </div>

        <!-- æ‹ç…§è®°å½• -->
        <div v-else class="space-y-3 text-sm">
          <p>æ‹ä¸€å¼ æ­£åœ¨åƒ / åƒå®Œçš„é¤ç›˜ç…§ç‰‡ï¼Œè®©å°ka å¸®ä½ ä¼°ç®—ä¸€é¡¿çš„å¤§è‡´çƒ­é‡ã€‚</p>
          <label class="pixel-btn blue py-2 inline-flex items-center gap-2 cursor-pointer">
            <span>ä¸Šä¼ ç…§ç‰‡</span>
            <input type="file" accept="image/*" class="hidden" @change="uploadPhoto">
          </label>
          <div v-if="lastPhotoResult" class="mt-2 text-xs border-t border-dashed border-gray-200 pt-2">
            <div class="font-bold">ä¸Šæ¬¡è¯†åˆ«ç»“æœï¼š</div>
            <div>{{ lastPhotoResult.name }} â‰ˆ {{ lastPhotoResult.cal }} kcal</div>
          </div>
        </div>

      </div>

    </div>

    <!-- å³åˆ—ï¼šè®°å½• + åˆ†æ -->
    <div class="space-y-4">

      <!-- ä»Šæ—¥è®°å½• -->
      <div class="pixel-box p-4 space-y-3">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold text-lg">ä»Šæ—¥è®°å½•</div>
          <button class="pixel-btn px-3 py-1 text-xs" @click="openWeightModal">âš–ï¸ è®°ä½“é‡</button>
        </div>
        <div v-if="!dashboard.history.length" class="text-xs text-gray-400">
          è¿˜æ²¡æœ‰è®°å½•ï¼Œå…ˆåœ¨å·¦è¾¹æ·»åŠ ä¸€é¡¿é¥­æˆ–ä¸€æ¡ä½“é‡å§ã€‚
        </div>
        <div v-for="item in dashboard.history" :key="item.id"
             class="flex items-center justify-between py-2 border-b border-dashed border-gray-200">
          <div class="flex items-center gap-2">
            <span class="text-xl">{{ item.type==='weight' ? 'âš–ï¸' : 'ğŸ”' }}</span>
            <div>
              <div class="text-sm font-semibold">{{ item.note || (item.type==='weight' ? 'ä½“é‡' : 'è®°å½•') }}</div>
              <div class="text-[11px] text-gray-400">{{ item.date }}</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-lg font-bold">
              {{ item.type==='weight' ? item.value.toFixed(1)+' kg' : item.value.toFixed(0)+' kcal' }}
            </span>
            <button class="text-red-500 text-lg leading-none" @click="deleteLog(item.id)">âœ•</button>
          </div>
        </div>
      </div>

      <!-- å³ä¸‹ï¼šçƒ­é‡æ—¥å† + å°ka æŠ¥å‘Š -->
      <div class="pixel-box p-4 space-y-3">
        <div class="flex items-center mb-2">
          <div class="font-bold text-lg">çƒ­é‡æ—¥å†</div>
          <div class="ml-4 flex items-center gap-2 text-xs">
            <span class="inline-block w-3 h-3 bg-green-300 border border-black"></span><span>è¾¾æ ‡</span>
            <span class="inline-block w-3 h-3 bg-red-200 border border-black ml-2"></span><span>è¶…æ ‡</span>
          </div>
          <button class="pixel-btn green ml-auto px-3 py-1 text-xs" @click="genDailyReport">
            ğŸ¾ å°ka ä»Šæ—¥æŠ¥å‘Š
          </button>
        </div>

        <!-- æ—¥å†çƒ­åŠ›å›¾ -->
        <div class="space-y-2">
          <div class="text-xs text-gray-500">
            {{ calendarYear }} å¹´ {{ calendarMonth }} æœˆ
          </div>
          <div class="grid grid-cols-7 gap-1 text-[11px]">
            <div class="text-center text-gray-500" v-for="w in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="w">
              {{ w }}
            </div>
            <div v-for="cell in calendarCells" :key="cell.key"
                 class="h-8 flex items-center justify-center border-2 border-black"
                 :class="cell.bgClass">
              <span v-if="cell.day">{{ cell.day }}</span>
            </div>
          </div>
        </div>

        <!-- AI æŠ¥å‘Š -->
        <div v-if="dailyReportText" class="mt-3 text-xs bg-yellow-50 border-2 border-black p-2 leading-relaxed">
          <div class="font-semibold mb-1">ä»Šæ—¥æŠ¥å‘Š</div>
          <div>{{ dailyReportText }}</div>
        </div>
      </div>

    </div>

  </div>

  <!-- é€šç”¨è¾“å…¥å¼¹çª— -->
  <div v-if="modal.show" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="pixel-box bg-white w-full max-w-sm p-5 space-y-4">
      <div class="text-lg font-bold border-b-4 border-black pb-2">
        {{ modal.note || (modal.type==='weight' ? 'è®°å½•ä½“é‡' : 'æ–°å¢è®°å½•') }}
      </div>

      <div v-if="modal.fromFoodDb" class="text-xs bg-yellow-100 border-2 border-black p-2">
        æ¯ 100gï¼š{{ modal.per100 }} kcal
      </div>
      <div v-else-if="modal.isSmart" class="text-xs bg-yellow-100 border-2 border-black p-2">
        å°ka æç¤ºå€¼ï¼š{{ modal.inputVal }} kcal
      </div>

      <input type="number" v-model.number="modal.inputVal"
             class="w-full text-3xl font-bold text-center border-2 border-black p-2"
             :placeholder="modal.fromFoodDb ? 'åƒäº†å¤šå°‘å…‹ï¼Œä¾‹å¦‚ 80' : '0'">

      <div class="grid grid-cols-2 gap-3">
        <button class="pixel-btn bg-gray-200 py-2" @click="modal.show=false">å–æ¶ˆ</button>
        <button class="pixel-btn green py-2" @click="submitLog">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·ç®¡ç†å¼¹çª— -->
  <div v-if="showUserModal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="pixel-box bg-white w-full max-w-3xl p-4 grid md:grid-cols-3 gap-4">
      <!-- ç”¨æˆ·åˆ—è¡¨ -->
      <div class="md:col-span-1 border-r-4 border-dashed pr-2 space-y-2 max-h-80 overflow-y-auto text-sm">
        <div class="font-bold mb-1">ç”¨æˆ·</div>
        <div v-for="u in userList" :key="u.id"
             class="p-2 border-2 cursor-pointer flex justify-between items-center"
             :class="u.id===currentUserId ? 'bg-green-100 border-green-500' : 'bg-gray-100 border-gray-300'"
             @click="switchUser(u)">
          <span>{{ u.name }}</span>
          <span v-if="u.id===currentUserId" class="text-xs text-green-600">å½“å‰</span>
        </div>
        <button class="pixel-btn w-full py-1 text-xs mt-2" @click="createUser">+ æ–°å»ºç”¨æˆ·</button>
      </div>

      <!-- èº«ä½“å‚æ•° -->
      <div class="md:col-span-2 space-y-3 text-sm">
        <div class="font-bold text-base">èº«ä½“å‚æ•°</div>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">
            èº«é«˜ (cm)
            <input type="number" v-model.number="profileForm.height" class="w-full p-1 border-2 border-black mt-1">
          </label>
          <label class="text-xs">
            å¹´é¾„
            <input type="number" v-model.number="profileForm.age" class="w-full p-1 border-2 border-black mt-1">
          </label>
          <label class="text-xs">
            å½“å‰ä½“é‡ (kg)
            <input type="number" v-model.number="profileForm.current_weight_input" class="w-full p-1 border-2 border-black mt-1">
          </label>
          <label class="text-xs">
            ç›®æ ‡ä½“é‡ (kg)
            <input type="number" v-model.number="profileForm.target_weight" class="w-full p-1 border-2 border-black mt-1">
          </label>
          <label class="text-xs col-span-2">
            æ€§åˆ«
            <select v-model="profileForm.gender" class="w-full p-1 border-2 border-black mt-1">
              <option value="female">å¥³</option>
              <option value="male">ç”·</option>
            </select>
          </label>
        </div>
        <div class="flex justify-between items-center mt-2">
          <button class="pixel-btn bg-gray-200 px-3 py-1 text-xs" @click="showUserModal=false">å…³é—­</button>
          <div class="space-x-2">
            <button class="pixel-btn green px-3 py-1 text-xs" @click="saveProfile">ä¿å­˜</button>
            <button v-if="userList.length>1"
                    class="pixel-btn px-3 py-1 text-xs" style="background:#f87171;color:white"
                    @click="deleteCurrentUser">åˆ é™¤å½“å‰ç”¨æˆ·</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endraw %}
<script src="/static/js/diet.js"></script>
{% endblock %}
